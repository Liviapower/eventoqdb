<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Resgate Promoção Harry Potter</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
 
  <style>
    /* Seu CSS completo e perfeito permanece aqui */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { min-height: 100vh; display: flex; justify-content: center; align-items: center; font-family: 'circular', sans-serif; background: url('estrelado.jpg') no-repeat center center; background-size: cover; background-attachment: fixed; overflow: hidden; }
    .hidden { visibility: hidden; opacity: 0; pointer-events: none; transition: visibility 0s 0.5s, opacity 0.5s ease; }
    #tela-inicial { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 10000; transition: opacity 0.5s ease; }
    #carta-imagem { height: 80vh; aspect-ratio: 3/4; background: url('./images/hp.png') no-repeat center center/contain; border: none; transition: transform 0.3s ease; }
    #tela-inicial:hover #carta-imagem { transform: scale(1.02); }
    #animacao { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; background: transparent; z-index: 9999; height: 80vh; width: calc(80vh * (3/4)); opacity: 0; transition: all 1s ease-in-out; }
    #animacao.expandir { height: 100vh; width: 100vw; opacity: 1; }
    #animacao img { width: 100%; height: 100%; object-fit: contain; }
    .form-wrapper { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 16px; width: 100%; max-width: 420px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); text-align: center; transition: opacity 0.8s ease; }
    h1 { font-size: 22px; margin-bottom: 20px; color: #0b3d91; }
    form label { display: block; text-align: left; margin: 12px 0 5px; font-weight: bold; font-size: 14px; }
    form input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #aaa; margin-bottom: 15px; font-size: 14px; }
    input.valid { border-color: #2ecc71; }
    input.invalid { border-color: #e74c3c; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    button { width: 100%; padding: 14px; background: #0b3d91; color: #fff; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; transition: background 0.3s ease; }
    button:hover:not(:disabled) { background: #092f70; }
    .checkbox-label { display: flex; align-items: center; text-align: left; font-size: 14px; margin-bottom: 15px; }
    .checkbox-label input { width: auto; margin-right: 10px; margin-bottom: 0; }
    #voucher-screen { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; z-index: 10001; transition: opacity 0.8s ease; }
    .success-container { display: flex; flex-direction: column; align-items: center; max-width: 90%; }
    .success-container img.voucher-image { height: 80vh; aspect-ratio: 3/4; object-fit: contain; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); margin-bottom: 25px; }
    .voucher-box { width: 100%; max-width: 400px; background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); text-align: center; }
    .voucher-box h2 { font-size: 16px; color: #555; font-weight: normal; margin-bottom: 8px; }
    .voucher-code { font-family: 'Courier New', Courier, monospace; font-size: 28px; font-weight: bold; color: #0b3d91; letter-spacing: 2px; border: 2px dashed #ccc; padding: 10px 15px; border-radius: 8px; background-color: #f9f9f9; word-break: break-all; }
  </style>
</head>
<body>

  <!-- HTML sem alterações -->
  <div id="tela-inicial"><div id="carta-imagem"></div></div>
  <div id="form-wrapper" class="form-wrapper hidden">
    <h1>Resgate seu Cupom</h1>
    <form id="promoForm">
      <label for="nome">Nome completo *</label>
      <input type="text" id="nome" name="nome" required>
      <label for="cpf">CPF *</label>
      <input type="text" id="cpf" name="cpf" required placeholder="000.000.000-00" maxlength="14">
      <label class="checkbox-label">
        <input type="checkbox" id="politica" name="politica" required> Li e concordo com a Política de Privacidade.
      </label>
      <button type="submit" id="submit-button" disabled>Resgatar meu cupom</button>
    </form>
  </div>
  <div id="voucher-screen" class="hidden">
    <div class="success-container">
      <img src="ENVELOPEVERSO.png" alt="Voucher de 10% de desconto" class="voucher-image">
      <div class="voucher-box">
        <h2>Seu código de resgate é:</h2>
        <p id="voucher-code-display" class="voucher-code"></p>
      </div>
    </div>
  </div>

  <script>
    // --- LÓGICA DE UI E VALIDAÇÃO ---
    const telaInicial = document.getElementById('tela-inicial');
    const formWrapper = document.getElementById('form-wrapper');
    const voucherScreen = document.getElementById('voucher-screen');
    const voucherCodeDisplay = document.getElementById('voucher-code-display');
    const duracaoGif = 5000;
    const form = document.getElementById('promoForm');
    const nomeInput = document.getElementById('nome');
    const cpfInput = document.getElementById('cpf');
    const politicaCheckbox = document.getElementById('politica');
    const submitButton = document.getElementById('submit-button');

    // --- LÓGICA ANTI-ATUALIZAÇÃO ---
    function verificarStatusDoCupom() {
      const cupomSalvo = localStorage.getItem('meuCupomQDBHP');
      if (cupomSalvo) {
        telaInicial.classList.add('hidden');
        formWrapper.classList.add('hidden');
        animacao.classList.add('hidden');
        voucherCodeDisplay.textContent = cupomSalvo;
        voucherScreen.classList.remove('hidden');
      }
    }
    document.addEventListener('DOMContentLoaded', verificarStatusDoCupom);

    // --- LÓGICA DO FLUXO NORMAL (CLIQUE NA CARTA) ---
    telaInicial.addEventListener('click', () => {
      telaInicial.classList.add('hidden');
      animacao.classList.remove('hidden');
      void animacao.offsetWidth;
      animacao.classList.add('expandir');
      setTimeout(() => {
        animacao.classList.add('hidden');
        formWrapper.classList.remove('hidden');
      }, duracaoGif);
    });

    // --- FUNÇÕES DE VALIDAÇÃO (SEM ALTERAÇÃO) ---
    cpfInput.addEventListener('input', (e) => { let v=e.target.value.replace(/\D/g,''); v=v.replace(/(\d{3})(\d)/,'$1.$2'); v=v.replace(/(\d{3})(\d)/,'$1.$2'); v=v.replace(/(\d{3})(\d{1,2})$/,'$1-$2'); e.target.value=v; validarCPF(v); checkFormValidity(); });
    function validarCPF(c){c=c.replace(/[^\d]+/g,'');cpfInput.classList.remove('valid','invalid');if(c.length!==11||/^(\d)\1+$/.test(c)){if(c.length>0)cpfInput.classList.add('invalid');return!1}let s=0,r;for(let i=1;i<=9;i++)s+=parseInt(c.substring(i-1,i))*(11-i);r=(s*10)%11;if(r===10||r===11)r=0;if(r!==parseInt(c.substring(9,10))){cpfInput.classList.add('invalid');return!1}s=0;for(let i=1;i<=10;i++)s+=parseInt(c.substring(i-1,i))*(12-i);r=(s*10)%11;if(r===10||r===11)r=0;if(r!==parseInt(c.substring(10,11))){cpfInput.classList.add('invalid');return!1}cpfInput.classList.add('valid');return!0}
    function checkFormValidity(){const a=nomeInput.value.trim()!=='',b=validarCPF(cpfInput.value),c=politicaCheckbox.checked;submitButton.disabled=!(a&&b&&c)}
    nomeInput.addEventListener('input',checkFormValidity);politicaCheckbox.addEventListener('change',checkFormValidity);

    // --- LÓGICA DE ENVIO FINAL E CORRIGIDA ---
    // !!! COLE O SEU URL DO APPS SCRIPT AQUI DENTRO DAS ASPAS !!!
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyWK6US549Nf_MJrkucELgM88itCtQuckTMqaIrzD22JJzp_FRDnfaEC_YhDrXpjrE0/exec';

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      if (submitButton.disabled) return;

      submitButton.disabled = true;
      submitButton.textContent = 'Enviando...';

      // --- MUDANÇA CRUCIAL AQUI ---
      // Criamos o FormData manualmente para garantir os nomes dos campos
      const formData = new FormData();
      const cpfLimpo = cpfInput.value.replace(/\D/g, '');
      const hashSimples = (parseInt(cpfLimpo.substr(0, 9)) % 10000).toString().padStart(4, '0');
      const novoCodigo = `QDBHP${hashSimples}`;
     
      formData.append('CPF', cpfInput.value); // O Apps Script espera 'CPF'
      formData.append('NOME', nomeInput.value); // O Apps Script espera 'NOME'
      formData.append('CUPOM', novoCodigo); // O Apps Script espera 'CUPOM'

      fetch(scriptURL, { method: 'POST', body: formData})
        .then(response => {
            if (!response.ok) {
                // Se a resposta não for OK (ex: 404, 500), lança um erro
                throw new Error(`Erro de rede: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
          if (data.result === 'success') {
            localStorage.setItem('meuCupomQDBHP', novoCodigo);
            formWrapper.classList.add('hidden');
            voucherCodeDisplay.textContent = novoCodigo;
            voucherScreen.classList.remove('hidden');
          } else if (data.error === 'CPF_EXISTS') {
            alert('Este CPF já foi cadastrado e possui um cupom.');
            submitButton.disabled = false;
            submitButton.textContent = 'Resgatar meu cupom';
          } else {
            // Se o script retornou um erro que não é 'CPF_EXISTS'
            throw new Error(data.error || 'Erro desconhecido retornado pelo script.');
          }
        })
        .catch(error => {
          console.error('Erro detalhado:', error);
          alert('Ocorreu um erro ao conectar com o servidor. Por favor, tente novamente.');
          submitButton.disabled = false;
          submitButton.textContent = 'Resgatar meu cupom';
        });
    });
  </script>

</body>
</html>








